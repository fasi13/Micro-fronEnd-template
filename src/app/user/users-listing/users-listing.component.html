<div class="fge-group--title row">
  <h4 class="fge-group--title-divider my-2 col-10">
    <i *ngIf="usersState?.loading" class="fas fa-circle-notch fa-spin"></i><span class="pl-2">User Management</span>
  </h4>
  <div class="col text-right">
    <button type="button" class="btn btn-link"><i class="fas fa-user-plus" (click)="userFormModal.open()"></i></button>
  </div>
</div>
<table class="table table-bordred fge-group--content-list">
  <thead>
    <tr class="row m-0">
      <th class="col border-bottom-0 pt-0 border-top-0">
        <ng-container
          [ngTemplateOutlet]="filterInput"
          [ngTemplateOutletContext]="{label: 'Username', field: 'login'}"
        ></ng-container>
      </th>
      <th class="col border-bottom-0 pt-0 border-top-0">
        <ng-container
          [ngTemplateOutlet]="filterInput"
          [ngTemplateOutletContext]="{label: 'First Name', field: 'firstName'}"
        ></ng-container>
      </th>
      <th class="col border-bottom-0 pt-0 border-top-0">
        <ng-container
          [ngTemplateOutlet]="filterInput"
          [ngTemplateOutletContext]="{label: 'Last Name', field: 'lastName'}"
        ></ng-container>
      </th>
      <th class="col border-bottom-0 pt-0 border-top-0">
        <ng-container
          [ngTemplateOutlet]="filterInput"
          [ngTemplateOutletContext]="{label: 'Email', field: 'email'}"
        ></ng-container>
      </th>
      <th class="col border-bottom-0 pt-0 border-top-0">
      </th>
      <th class="col-2 border-bottom-0 pt-0 border-top-0">
        <ng-container
          [ngTemplateOutlet]="filterDate"
          [ngTemplateOutletContext]="{label: 'Last Login', field: 'lastLoginDate'}"
        ></ng-container>
      </th>
      <th class="col-1 border-bottom-0 pt-0 border-top-0">
      </th>
    </tr>
    <tr class="row m-0 thead-light">
      <th class="col">
        Username
      </th>
      <th class="col">
        Fist Name
      </th>
      <th class="col">
        Last Name
      </th>
      <th class="col">
        Email
      </th>
      <th class="col">
        Application
      </th>
      <th class="col-2">
        Last Login
      </th>
      <th class="col-1">
        Actions
      </th>
    </tr>
  </thead>
  <tbody>
    <tr *ngIf="usersState?.items?.length <= 0 && !usersState?.loading">
      <td class="col text-center">
        <h6><i class="fas fa-info-circle"></i> No users found</h6>
      </td>
    </tr>
    <tr class="row m-0" *ngFor="let user of usersState?.items">
      <td class="col">{{ user.login }}</td>
      <td class="col">{{ user.firstName }}</td>
      <td class="col">{{ user.lastName }}</td>
      <td class="col">{{ user.email }}</td>
      <td class="col">{{ getApplicationPath(user.applicationPath) }}</td>
      <td class="col-2">{{ user.lastLoginDate | date:'medium' }}</td>
      <td class="col-1">
        <a class="btn btn-primary bg-primary btn-sm mr-2" tabindex="0" (click)="userFormModal.open(user)">
          <i class="fas fa-edit"></i>
        </a>
        <a class="btn btn-primary bg-primary btn-sm mr-2" tabindex="0" (click)="openModalConfirm(modalConfirmModal, user)">
          <i class="fas fa-edit" [ngClass]="{'fa-user-alt': user.isActive, 'fa-user-slash': !user.isActive }"></i>
        </a>
      </td>
    </tr>
  </tbody>
</table>
<ngb-pagination
  class="d-flex justify-content-center"
  *ngIf="usersState?.totalCount > usersState?.limit"
  [collectionSize]="usersState?.totalCount"
  [(page)]="pageNumber"
  [pageSize]="usersState?.limit"
  [maxSize]="5"
  [rotate]="true"
  [ellipses]="false"
  [boundaryLinks]="true"
  (pageChange)="onPageChange($event)"
  size="sm"
></ngb-pagination>

<ng-template #filterInput let-label="label" let-field="field">
  <div class="input-group input-group-sm mt-1">
    <div class="input-group-prepend fge-clickable" (click)="onPerformFilter(field, box.value)">
      <span class="input-group-text">
        <i class="fas fa-search"></i>
      </span>
    </div>
    <input
      [(ngModel)]="filters[field]"
      type="text"
      class="form-control"
      placeholder="{{label}}"
      (keyup.enter)="onPerformFilter()"
      (keyup.esc)="onResetFilters()">
  </div>
</ng-template>

<ng-template #filterDate let-label="label" let-field="field">
  <div class="input-group input-group-sm mt-1">
    <div class="input-group-prepend fge-clickable" (click)="datepicker.toggle()">
      <span class="input-group-text">
        <i class="fas fa-calendar-alt"></i>
      </span>
    </div>
    <input disabled class="form-control" [value]="range_date" placeholder="{{label}}" /> 
    <input
      class="form-control d-none"
      name="dp"
      [(ngModel)]="model"
      ngbDatepicker
      [dayTemplate]="dayTemplate"
      [autoClose]="false"
      [displayMonths]="2"
      placement="bottom-right"
      #datepicker="ngbDatepicker">
  </div>
  <ng-template #dayTemplate let-date="date" let-focused="focused">
      <span class="fge-datepicker--day"
        [class.range]="isFrom(date) || isTo(date) || isInside(date) || isHovered(date)"
        [class.faded]="isHovered(date) || isInside(date)"
        (click)="onDateSelection(date)"
        (mouseenter)="hoveredDate = date"
        (mouseleave)="hoveredDate = null"
      >
      {{ date.day }}
      </span>
  </ng-template>
</ng-template>

<fge-user-form-modal #userFormModal></fge-user-form-modal>

<fge-modal-confirm [config]="config"
  (onsubmit)="onSubmitConfirmModal()"
  #modalConfirmModal>
</fge-modal-confirm>