<div class="fge-group--title row">
  <h4 class="fge-group--title-divider my-2 col-10">
    <i *ngIf="reportsState?.loading" class="fas fa-circle-notch fa-spin"></i
    ><span class="pl-2">Reports / Audit Reports</span>
  </h4>
  <div class="col text-right align-self-center">
    <button
      type="button"
      class="btn btn-sm btn-secondary bg-secondary"
      (click)="exportAuditData()"
      title="Click to export"
    >
      Export
      <i class="far fa-file-excel pl-1"></i>
    </button>
  </div>
</div>
<div class="row m-0">
    <div class="col--checkbox fge-table__col border-bottom-0 pt-0 border-top-0">
      </div>
    <div class="col fge-table__col border-bottom-0 pt-0 border-top-0">
    <ng-container
      [ngTemplateOutlet]="filterInput"
      [ngTemplateOutletContext]="{ label: 'Username', field: 'login' }"
    >
    </ng-container>
  </div>
  <div class="col fge-table__col border-bottom-0 pt-0 border-top-0">
    <ng-container
      [ngTemplateOutlet]="filterInput"
      [ngTemplateOutletContext]="{ label: 'First Name', field: 'firstName' }"
    >
    </ng-container>
  </div>
  <div class="col fge-table__col border-bottom-0 pt-0 border-top-0">
    <ng-container
      [ngTemplateOutlet]="filterInput"
      [ngTemplateOutletContext]="{ label: 'Last Name', field: 'lastName' }"
    >
    </ng-container>
  </div>
  <div class="col-2 fge-table__col border-bottom-0 pt-0 border-top-0">
    <ng-container
      [ngTemplateOutlet]="filterInput"
      [ngTemplateOutletContext]="{ label: 'Application', field: 'application' }"
    >
    </ng-container>
  </div>
  <div class="col fge-table__col border-bottom-0 pt-0 border-top-0">
    <ng-container
      [ngTemplateOutlet]="filterInput"
      [ngTemplateOutletContext]="{ label: 'Activity', field: 'actionPerformed' }"
    >
    </ng-container>
  </div>
  <div class="col-2 fge-table__col--action--date border-bottom-0 pt-0 border-top-0">
    <ng-container
      [ngTemplateOutlet]="filterDate"
      [ngTemplateOutletContext]="{ label: 'Date', field: 'actionDate' }"
    >
    </ng-container>
  </div>
  <div class="col-1 fge-table__col border-bottom-0 pt-0 border-top-0 fge-table--actions">
  </div>
</div>
<div class="fge-table">
  <div class="row m-0 fge-table__header">
    <div class="col--checkbox fge-table__col"></div>
    <div class="col fge-table__col fge-clickable" (click)="sortBy('login')">
      Username
      <span *ngIf="sort.sortby === 'login'">
        <i class="fas fa-caret-up" *ngIf="sort.sortdirection === 'asc'"></i>
        <i class="fas fa-caret-down" *ngIf="sort.sortdirection === 'desc'"></i>
      </span>
    </div>
    <div class="col fge-table__col fge-clickable" (click)="sortBy('firstName')">
      First Name
      <span *ngIf="sort.sortby === 'firstName'">
        <i class="fas fa-caret-up" *ngIf="sort.sortdirection === 'asc'"></i>
        <i class="fas fa-caret-down" *ngIf="sort.sortdirection === 'desc'"></i>
      </span>
    </div>
    <div class="col fge-table__col fge-clickable" (click)="sortBy('lastName')">
      Last Name
      <span *ngIf="sort.sortby === 'lastName'">
        <i class="fas fa-caret-up" *ngIf="sort.sortdirection === 'asc'"></i>
        <i class="fas fa-caret-down" *ngIf="sort.sortdirection === 'desc'"></i>
      </span>
    </div>
    <div class="col-2 fge-table__col fge-clickable" (click)="sortBy('application')">
      Application
      <span *ngIf="sort.sortby === 'application'">
        <i class="fas fa-caret-up" *ngIf="sort.sortdirection === 'asc'"></i>
        <i class="fas fa-caret-down" *ngIf="sort.sortdirection === 'desc'"></i>
      </span>
    </div>
    <div class="col fge-table__col fge-clickable" (click)="sortBy('actionPerformed')">
      Activity
      <span *ngIf="sort.sortby === 'actionPerformed'">
        <i class="fas fa-caret-up" *ngIf="sort.sortdirection === 'asc'"></i>
        <i class="fas fa-caret-down" *ngIf="sort.sortdirection === 'desc'"></i>
      </span>
    </div>
    <div class="col-2 fge-table__col fge-clickable" (click)="sortBy('actionDate')">
      Activity Date
      <span *ngIf="sort.sortby === 'actionDate'">
        <i class="fas fa-caret-up" *ngIf="sort.sortdirection === 'asc'"></i>
        <i class="fas fa-caret-down" *ngIf="sort.sortdirection === 'desc'"></i>
      </span>
    </div>
    <div class="col-1 fge-table__col fge-table--actions">
      Action
    </div>
  </div>
  <div class="row m-0" *ngIf="reportsState?.items?.length <= 0 && !reportsState?.loading">
    <div class="col fge-table__col text-center">
      <h6><i class="fas fa-info-circle"></i> No activities found</h6>
    </div>
  </div>
  <div class="row fge-table__row m-1" *ngFor="let report of (reports$ | async)">
    <div class="col--checkbox fge-table__col" title="{{ report.id }}">
      <input type="checkbox"/>
    </div>
    <div class="col fge-table__col" title="{{ report.login }}">{{ report.login }}</div>
    <div class="col fge-table__col" title="{{ report.firstName }}">{{ report.firstName }}</div>
    <div class="col fge-table__col" title="{{ report.lastName }}">{{ report.lastName }}</div>
    <div class="col-2 fge-table__col--app-path" title="{{ report.application | fgeApplicationPath }}">
      <span>{{ report.application | fgeApplicationPath }}</span>
    </div>
    <div class="col fge-table__col" title="{{ report.actionPerformed }}">{{ report.actionPerformed }}</div>
    <div class="col-2 fge-table__col" title="{{ report.actionDate | date:'medium' }}">{{ report.actionDate | date:'medium'}}</div>
    <div class="col-1 fge-table__col pr-0 fge-table--actions">
      <a class="btn btn-secondary bg-secondary btn-sm mr-2" tabindex="0">
        <i class="fas fa-edit"></i>
      </a>
    </div>
  </div>
  <ngb-pagination
    class="d-flex justify-content-center pt-3"
    *ngIf="reportsState?.totalCount > reportsState?.limit"
    [collectionSize]="reportsState?.totalCount"
    [page]="pageNumber"
    [pageSize]="reportsState?.limit"
    [maxSize]="5"
    [rotate]="true"
    [ellipses]="false"
    [boundaryLinks]="true"
    (pageChange)="onPageChange($event)"
    size="sm"
  ></ngb-pagination>
</div>
<ng-template #filterInput let-label="label" let-field="field">
  <div class="input-group input-group-sm mt-1">
    <div class="input-group-prepend fge-clickable" (click)="onPerformFilter()">
      <span class="input-group-text">
        <i class="fas fa-search"></i>
      </span>
    </div>
    <input
      [(ngModel)]="filters[field]"
      type="text"
      class="form-control"
      placeholder="{{ label }}"
      (keyup.enter)="onPerformFilter()"
      (keyup.esc)="onResetFilters()"
    />
  </div>
</ng-template>

<ng-template #filterDate let-label="label" let-field="field">
    <div class="input-group input-group-sm mt-1">
      <div class="input-group-prepend fge-clickable" (click)="datepicker.toggle()">
        <span class="input-group-text">
          <i class="fas fa-calendar-alt"></i>
        </span>
      </div>
      <input disabled class="form-control" [value]="range_date" placeholder="{{ label }}" /> 
      <input
        class="form-control d-none"
        name="dp"
        [(ngModel)]="model"
        ngbDatepicker
        [dayTemplate]="dayTemplate"
        [autoClose]="false"
        [displayMonths]="2"
        placement="bottom-right"
        #datepicker="ngbDatepicker">
    </div>
</ng-template>
<ng-template #dayTemplate let-date="date" let-focused="focused">
    <span class="fge-datepicker--day"
      [class.focused]="focused"
      [class.range]="isFrom(date) || isTo(date) || isInside(date) || isHovered(date)"
      [class.faded]="isHovered(date) || isInside(date)"
      (click)="onDateSelection(date)"
      (mouseenter)="hoveredDate = date"
      (mouseleave)="hoveredDate = null"
    >
        {{ date.day }}
    </span>
</ng-template>
